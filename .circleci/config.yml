version: 2

defaults: &defaults
    working_directory: ~/spotify-to-youtube
    docker:
        - image: circleci/node:latest

filter-publish: &filter-publish
    filters:
        tags: {only: /^v\d*\.\d*\.\d*/}
        branches: { only: [master] }

workflows:
    version: 2
    go:
        jobs:
            - install
            - build: { requires: [install] }
            - test: { requires: [build] }
            - hold:
                requires: [ test ]
                type: approval
                <<: *filter-publish
            - publish:
                requires: [ hold ]
                <<: *filter-publish

jobs:
    install:
        <<: *defaults
        steps:
            - checkout
            - restore-cache:
                key: node_modules
            - run: npm i -g yarn
            - run: yarn
            - save-cache:
                key: node_modules
                paths:
                    - node_modules
    build:
        <<: *defaults
        steps:
            - run: npm run build
    test:
        <<: *defaults
        steps:
            - run: yarn test
    publish:
        <<: *defaults
        steps:
            - run: yarn publish
